%% ------------------------------------------------------------------------- %%
\chapter{Análise exploratória}
\label{cap:analise-exploratoria}

\begin{flushright}
	\textcolor{gray}{
		\begin{tabular}{r}
			The greatest value of a picture \\
			is when it forces us to notice \\
			what we never expected to see \\
			--- John Tukey
		\end{tabular} 
	}	
\end{flushright}
\vspace{5mm}

A análise exploratória corresponde a etapa ``Visualizar'' do ciclo da ciência de dados (Figura \ref{fig:intro-ciclo}) e caracteriza a primeira tentativa de se extrair informação dos dados. Seu objetivo é gerar conhecimento inicial acerca do fenômeno sob estudo para guiar a etapa de modelagem. Existem diversas maneiras de conduzir uma análise exploratória, e a estratégia aplicada a cada problema depende do tipo de variável com que estamos trabalhando.

Como estudos de poluição do ar geralmente envolvem \textit{séries temporais}, apresentaremos diversas técnicas para explorar variáveis dessa natureza. Uma visão mais geral sobre a análise exploratória de dados pode ser encontrada em \cite{R4DS2017}.

Séries temporais compreendem variáveis observadas repetidas vezes ao longo de grandes períodos de tempo. Por simplicidade computacional, as metodologias usuais para a análise de séries temporais supõem que as observações são realizadas em intervalos equidistantes. Dado que esse é o cenário mais comum na prática, o enfoque deste trabalho será na análise de séries com essa característica. Para a análise de séries com observações não igualmente espaçadas, recomendamos a leitura de \cite{Eckner2018}.

O efeito do tempo nas observações é a grande peculiaridade das séries temporais, gerando características como \textit{tendência}, \textit{sazonalidade} e \textit{autocorrelação}, que influenciam diretamente a escolha do melhor modelo para os dados. A identificação dessas características é fundamental para a análise, o que torna a análise exploratória uma etapa de extrema importância no estudo de séries temporais. Discutiremos esse tópico na Seção \ref{sec:componentes-temporais}.

Séries temporais são normalmente representadas pela notação $\{Y_t, t \geq 0\}$. Neste texto, utilizaremos a forma simplificada $Y_t$. Aqui, $Y$ representa o fenômeno sob estudo, denominado como \textit{variável resposta}. O índice inteiro $t$ representa o instante em que essa variável foi avaliada (1, 2, 3, $\dots$), podendo ser medido em minutos, horas, dias, anos etc. Na maioria dos casos, estaremos interessados em associar $Y_t$ com $p$ outras variáveis, chamadas variáveis explicativas ou preditores. Essas variáveis serão denotadas aqui por $X_{1t}, X_{2t}, \dots, X_{pt}$. Quando não houver risco de ambiguidade, omitiremos o índice $t$ tanto de $Y_t$ quanto de $X_{1t}, X_{2t}, \dots, X_{pt}$.

Sob o contexto de estudos de poluição do ar, apresentaremos nas próximas seções as principais técnicas para análise exploratória de séries temporais.  Utilizaremos como exemplo as séries horárias de concentração de ozônio (O$_3$), óxido de nitrogênio (NO), dióxido de nitrogênio (NO$_2$) e temperatura, todas medidas na cidade de São Paulo de 2008 a 2013, disponibilizadas por \cite{Salvo2014} e \cite{Salvo2017} nos respectivos endereços: \href{http://bit.do/salvo_geiger_data}{http://bit.do/salvo\_geiger\_data} e \href{https://goo.gl/9tNzvj}{https://goo.gl/9tNzvj}. Em seguida, apresentaremos uma aplicação real de análise exploratória estudando os níveis de poluição durante a greve de caminhoneiros de 2018.

\section{Gráficos}
\label{sec:graficos}

\begin{flushright}
	\textcolor{gray}{
		\begin{tabular}{r}
			The simple graph has brought more information\\
			to the data analyst's mind than any other device  \\
			--- John Tukey
		\end{tabular} 
	}	
\end{flushright}
\vspace{5mm}

Nós construímos gráficos para elucidar informações sobre as variáveis que estão ``escondidas'' na base de dados. Para cumprir esse objetivo, um gráfico precisa ser facilmente compreendido, dado que gráficos muito verbosos podem ser mal interpretados e gerar mais confusão do que esclarecimento.

Embora o conceito de gráfico estatístico seja amplamente conhecido, não há um consenso geral sobre o que realmente é um gráfico e, por consequência, quais as melhores práticas para construí-lo. \cite{Leland2005} atacou esse problema definindo um gráfico estatístico como o mapeamento de variáveis em atributos estéticos de formas geométricas. Essa definição, conhecida como "a gramática dos gráficos", contempla os principais modelos gráficos já conhecidos e abre caminho para a criação de estratégias bem estruturadas para construção de gráficos.

\cite{Hadley2010}, por exemplo, utilizou a as ideias propostas por \cite{Leland2005} e definiu uma "gramática dos gráficos por camadas"\footnote{\textit{A layered grammar of graphics, em inglês.}}, acrescentando que cada elemento de um gráfico representa uma camada e que o gráfico em si é a sobreposição de todas as suas camadas. O resultado dessa definição foi a origem ao pacote de R \texttt{ggplot2}, sendo uma das melhores ferramentas atuais para criação de gráficos estáticos.

A visualização mais comum para séries temporais é o \textit{gráfico da série}. Com base na definição criada por Leland, as variáveis mapeadas serão o par ($t$, $Y_t$), as formas geométricas são retas e o atributo estético é a posição dessas retas em um eixo coordenado (com $t$, o tempo, no eixo $x$ e $Y_t$ no eixo $y$). A seguir, apresentamos  alguns exemplos de como construir e interpretar esses gráficos.

\subsection{O gráfico da série}
\label{sec:grafico-da-serie}

O gráfico da série é uma visualização da variável $Y_t$ contra o tempo. A partir dele, podemos observar a existência de diversos comportamentos, como tendência, sazonalidade e heteroscedasticidade\footnote{Variância não-constante ao longo do tempo.}, sendo a principal técnica de visualização de séries temporais.

Apesar de ser uma ferramenta de fácil construção e interpretação, quando o volume de dados é muito grande, a simples construção do gráfico da série pode não trazer toda a informação disponível nos dados. Uma boa estratégia nesse cenário é tentar diminuir a complexidade do problema, trabalhando inicialmente com casos particulares e, em seguida, buscar os padrões encontrados nos casos mais gerais.

Como exemplo de como explorar os dados utilizando o gráfico da série, vamos analisar a concentração horária de ozônio medida na região metropolitana de São Paulo, no período de 2008 a 2013, disponibilizada por \cite{Salvo2017}.

A base de dados contém medições de ozônio de 12 estações de monitoramento espalhadas pela cidade. A princípio, vamos analisar o gráfico de apenas uma delas, por exemplo, a estação Parque Dom Pedro II (Figura \ref{fig:cap-analise-explo-O3-DPII}). Podemos observar alguns períodos sem observação e, com a ajuda da série suavizada (por \textit{splines} cúbicos, ver Seção \ref{sec:gam-splines}), uma sazonalidade anual, com picos no início de cada ano.

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{figuras/cap-analise-explo-O3-DPII.pdf}
	\caption{Série da concentração de ozônio para a estação Dom Pedro II, na cidade de São Paulo, no período de 2008 a 2013. Em azul, a série suavizada usando \textit{splines} cúbicos.}
	\label{fig:cap-analise-explo-O3-DPII}
\end{figure}

Como a série é horária, o grande volume de observações pode ocultar alguns padrões. Para avaliar o comportamento da concentração de ozônio ao longo do dia, vamos analisar a concentração média horária dentro do período analisado (Figura \ref{fig:cap-analise-explo-O3-DPII-media-horaria}). Observamos que o pico de ozônio, em geral, acontece no começo da tarde, das 12 às 16 horas.

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{figuras/cap-analise-explo-O3-DPII-media-horaria.pdf}
	\caption{Série da concentração média de ozônio ao longo do dia para a estação Dom Pedro II, na cidade de São Paulo, no período de 2008 a 2013. Não existe informação para as 6 da manhã pois é o horário em que o equipamento sofre manutenção.}
	\label{fig:cap-analise-explo-O3-DPII-media-horaria}
\end{figure}

Podemos então considerar a média diária dentro desse período para avaliar apenas o horário em que a concentração de ozônio normalmente está alta. Observe pela Figura \ref{fig:cap-analise-explo-O3-DPII-media-diarias} que fica mais fácil observar o padrão sazonal. O padrão parece não ser o mesmo em 2009, mas essa diferença provavelmente se deve à falta de informação no período. Como indicado na Figura \ref{fig:cap-analise-explo-O3-todas-estacoes-media-diaria}, esse padrão se repete para todas as 12 estações.

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{figuras/cap-analise-explo-O3-DPII-media-diaria.pdf}
	\caption{Série diária da concentração média de ozônio medido no começo da tarde para a estação Dom Pedro II, na cidade de São Paulo, no período de 2008 a 2013. Em azul, a série suavizada usando \textit{splines} cúbicos.}
	\label{fig:cap-analise-explo-O3-DPII-media-diarias}
\end{figure}


Note que conduzir a análise exploratória na direção de casos particulares facilita a obtenção de informações importantes sobre o fenômeno. No exemplo, essa particularização poderia ainda ser feita em várias direções, como avaliar as diferenças entre os dias da semana ou as estações do ano.


\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{figuras/cap-analise-explo-O3-todas-estacoes-media-diaria.pdf}
	\caption{Série diária da concentração média de ozônio medido no começo da tarde para todas as estações, na cidade de São Paulo, no período de 2008 a 2013. Em azul, as séries suavizadas usando \textit{splines} cúbicos.}
	\label{fig:cap-analise-explo-O3-todas-estacoes-media-diaria}
\end{figure}

Muitas vezes, também temos interesse em estudar a relação entre duas séries. Os gráficos dessas séries, avaliadas em um mesmo período, podem então ser construídos na mesma figura como uma tentativa de encontrar padrões no comportamento conjunto das duas curvas. Na Figura \ref{fig:cap-analise-explo-O3-NO}, construímos gráficos das séries horárias de ozônio e de óxido de nitrogênio (NO), ambos medidos na estação Dom Pedro II, em São Paulo, no período de 2008 a 2011. Podemos observar que períodos de menor concentração de ozônio parecem estar associados a períodos de maior concentração de NO.

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{figuras/cap-analise-explo-O3-NO.pdf}
	\caption{Séries horárias de ozônio e de óxido de nitrogênio (NO), ambos medidos na estação Dom Pedro II, em São Paulo, no período de 2008 a 2011. Em azul, as séries suavizadas usando \textit{splines} cúbicos.}
	\label{fig:cap-analise-explo-O3-NO}
\end{figure}

Embora plotar o gráfico de duas séries na mesma figura possa trazer informações sobre como essas variáveis estão relacionadas, gráficos de dispersão são mais eficientes nessa tarefa. Na próxima seção, traremos alguns exemplos de como construir e interpretar esses gráficos.

\subsection{Gráficos de dispersão}
\label{sec:grafico-de-dispersao}

Gráficos de dispersão são amplamente utilizados na Estatística. Sua principal função é estudar a associação entre duas variáveis, sendo possível levantar indícios sobre a forma, intensidade e direção dessa relação, caso ela exista. Construímos esses gráficos posicionando pontos em um eixo cartesiano, sendo a variável resposta mapeada no eixo $y$ e a variável explicativa no eixo $x$. Podemos também adicionar curvas suavizadas para facilitar a identificação da associação.

Na Figura \ref{fig:cap-analise-explo-scatter-ozone-no}, apresentamos o gráfico de dispersão da concentração de ozônio contra a concentração de óxido de nitrogênio, ambas medidas das 12 às 16 horas, de 2008 a 2011. Observamos que a concentração de ozônio decresce exponencialmente conforme a concentração de NO aumenta. É conhecido que o ozônio ao longo da tarde reage com o NO, portanto espera-se que dias de alta concentração de ozônio tenham baixa concentração de NO e vice-versa.

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{cap-analise-explo-scatter-ozone-no.pdf}
	\caption{Gráfico de dispersão da concentração de ozônio contra a concentração de óxido de nitrogênio medidas das 12 às 16 horas na estação de monitoramento Dom Pedro II, em São Paulo, de 2008 a 2011.}
	\label{fig:cap-analise-explo-scatter-ozone-no}
\end{figure}

Apresentamos agora, na Figura \ref{fig:cap-analise-explo-scatter-ozone-no2}, o gráfico de dispersão da concentração de ozônio contra a concentração de dióxido de nitrogênio, ambas também medidas das 12 às 16 horas, de 2008 a 2011. Observe que não há indícios de associação entre as duas variáveis. No entanto, sabe-se que a fotólise do NO$_2$ pela manhã faz parte do processo gerador do ozônio ao longo da tarde. Na Figura \ref{fig:cap-analise-explo-scatter-ozone-no2-morning}, apresentamos o gráfico de dispersão da concentração de ozônio, medida à tarde, contra a concentração e dióxido de nitrogênio, agora medida pela manhã, das 7 às 11 horas. Observe que, neste caso, encontramos indícios de uma relação positiva entre as duas variáveis.   

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{cap-analise-explo-scatter-ozone-no2.pdf}
	\caption{Gráfico de dispersão da concentração de ozônio contra a concentração de dióxido de nitrogênio medidas das 12 às 16 horas na estação de monitoramento Dom Pedro II, em São Paulo, de 2008 a 2011.}
	\label{fig:cap-analise-explo-scatter-ozone-no2}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{cap-analise-explo-scatter-ozone-no2-morning.pdf}
	\caption{Gráfico de dispersão da concentração de ozônio, medida das 12 às 16 horas, contra a concentração de óxido de nitrogênio, medida das 7 às 11 horas, na estação de monitoramento Dom Pedro II, em São Paulo, de 2008 a 2011.}
	\label{fig:cap-analise-explo-scatter-ozone-no2-morning}
\end{figure}

Uma limitação dos gráficos de dispersão é não levar em conta o efeito de outras variáveis. Muitas vezes a associação dentre duas variáveis pode ser induzida ou mascarada pela ação de uma terceira. Portanto, é importante termos em mente que a interpretação desses gráficos levanta apenas indícios sobre a associação, que devem ser estudados com mais atenção, eliminando primeiro o possível efeito de outras variáveis.

\subsection{Gráficos de distribuição}
\label{sec:grafico-ridges}

Muitas vezes queremos observar a distribuição amostral de uma variável. Um gráfico muito comum nesses casos é o histograma. Na Figura \ref{fig:cap-analise-explo-hist-ozone}, apresentamos o histograma da concentração diária média medida de ozônio das 12 às 16 horas, em São Paulo, de 2008 a 2013. Podemos observar que a distribuição amostral é levemente assimétrica à direita, sendo que a maioria dos dias apresenta concentração de ozônio entre 25 e 75 $\mu$g/m$^3$.

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{cap-analise-explo-hist-ozone.pdf}
	\caption{Histograma da concentração diária média de ozônio medida das 12 às 16 horas na estação de monitoramento Dom Pedro II, na cidade de São Paulo, de 2008 a 2013.}
	\label{fig:cap-analise-explo-hist-ozone}
\end{figure}

Quando estamos interessados em, além de observar a distribuição amostral da variável resposta, compará-la entre os níveis de uma variável explicativa, podemos utilizar os \textit{boxplots}. A partir dos quantis da variável resposta, esses gráficos dão uma ideia geral da sua distribuição, para cada nível da variável explicativa. Eles também nos mostram a presença de pontos atípicos, isto é, observações com valores muito abaixo ou muito acima dos valores medianos. Os chamados \textit{ridges graphs} são outra boa alternativa para comparar a distribuição amostral de uma variável entre os níveis de um preditor. Eles são histogramas suavizados e trazem mais informação sobre a forma da distribuição do que os boxplots. Na Figura \ref{fig:cap-analise-explo-ridges-ozone-month}, apresentamos um exemplo desses gráficos. Podemos observar que as máximas de ozônio ocorrem nos meses mais quentes, sendo esses os períodos também de maior variação, provavelmente devido ao efeito conjunto da temperatura e da chuva.

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{cap-analise-explo-ridges-ozone-month.pdf}
	\caption{Distribuição por mês da concentração diária média de ozônio medida das 12 às 16 horas na estação de monitoramento Dom Pedro II, na cidade de São Paulo, de 2008 a 2013.}
	\label{fig:cap-analise-explo-ridges-ozone-month}
\end{figure}

Os gráficos apresentados até aqui geram bastante intuição sobre o comportamento do fenômeno sob estudo, mas seria interessante dispormos de medidas mais objetivas. Nas próximas seções, discutiremos os conceitos de estacionariedade e autocorrelação e como identificar essas características. Além disso, apresentaremos estratégias para conduzir a análise na presença de tendência e sazonalidade.

\section{Componentes temporais}
\label{sec:componentes-temporais}

Séries temporais normalmente sofrem influência de componentes temporais que não são causados pelo fenômeno que estamos estudando ou que estão ligados a variáveis que não puderam ser medidas. Imagine, por exemplo, que estamos investigando a associação da concentração de monóxido de carbono com o número de carros rodando no horário de pico na cidade de São Paulo. Sabemos que, historicamente, os níveis de monóxido de carbono vêm diminuindo, enquanto o número de carros na cidade de São Paulo tendem a aumentar. Se não controlarmos por nenhuma outra variável, nossa investigação pode concluir que o aumento do número de carros está diminuindo os níveis do poluente, o que não faria sentido prático pois sabemos que existe uma associação positiva entre as variáveis. Acontece que a diminuição histórica do monóxido de carbono se deve a regulamentações feitas em cima dos combustíveis e dos motores veiculares. Como podemos não ter dados disponíveis para incorporar essa informação no modelo, essa \textit{tendência} decrescente da série precisa ser eliminada ou controlada de alguma forma. Só assim conseguiremos quantificar corretamente o efeito do número de carros na concentração de monóxido de carbono.

Tendências são os componentes temporais mais comuns em séries de tempo. Outro componente muito frequente é \textit{sazonalidade}, que representa comportamento cíclicos em intervalos fixos de tempo. Em estudos de poluição, as estações do ano são a principal causa de sazonalidade.

A seguir discutiremos como identificar e eliminar esses componentes de uma série. No Capítulo \ref{cap:regressao} discutiremos como controlá-las incorporando termos de tendência e sazonalidade no modelo.

\subsection{Tendência}

A tendência de uma série pode ser eliminada pela utilização da \textit{série de diferenças}. A diferença de primeira ordem é definida como

\begin{displaymath}
\Delta Y_t = Y_t - Y_{t-1}, \quad t = 1, 2, \dots.
\end{displaymath}
Ela é utilizada para eliminar uma tendência linear de uma série. A ordem da diferença está associada ao grau da tendência. No caso de uma tendência quadrática, por exemplo, podemos utilizar a diferenciação de segunda ordem

\begin{displaymath}
\Delta^2 Y_t = \Delta Y_t - \Delta Y_{t-1}, \quad t = 1, 2, \dots.
\end{displaymath}
No caso geral, definimos a diferenciação de ordem $n$ como

\begin{equation}
\Delta^n Y_t = \Delta^{n-1} Y_t - \Delta^{n-1} Y_{t-1}, \quad t = 1, 2, \dots.
\label{def:diff}
\end{equation}
Na prática, dificilmente encontramos séries com tendência quadrática ou de grau mais elevado, então a diferença de primeiro grau é geralmente suficiente para alcançar a estacionariedade.

Como exemplo, observe a Figura \ref{fig:cap-analise-explo-asg-O3-trend}. No painel (a), temos a série da concentração diária média de ozônio, em que podemos observar uma leve tendência linear positiva, isto é, a concentração média parece crescer com o tempo. No painel (b), apresentamos o gráfico da série de diferenças (primeira ordem). Podemos observar que a série já não apresenta qualquer tendência linear.

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{figuras/cap-analise-explo-asg-O3-trend.pdf}
	\caption{Série da concentração de ozônio diária média, medida na cidade de São Paulo (estação de monitoramento Dom Pedro II), no período de outubro de 2008 a junho de 2011, das 12h às 16h.}
	\label{fig:cap-analise-explo-asg-O3-trend}
\end{figure}

Uma desvantagem de se utilizar a série de diferenças é a interpretação do modelo, já que a variável resposta ajustada terá sido a diferença entre duas observações consecutivas. As conclusões para essa nova variável nem sempre será interessante.

\subsection{Sazonalidade}

Em geral, o gráfico da série é suficiente para a identificação de sazonalidade. No entanto, em alguns casos, outras variáveis podem mascarar o efeito sazonal, sendo difícil identificar esse componente apenas observando o gráfico. Assim, é sempre recomendável a construção de um \textit{periodograma} para auxiliar a identificação da sazonalidade.

Toda série temporal pode ser decomposta em uma soma de ondas senoidais, com frequências e amplitudes diferentes \citep{Shumway2006}. Para um conjunto de ondas de frequências diferentes e fixadas a priori, podemos calcular quais são as amplitudes de cada uma dessas ondas para que a soma delas gere a série original. Podemos então definir uma medida de associação linear entre a série original e cada uma das ondas senoidais. Essa medida, chamada de \textit{densidade espectral}, é proporcional à amplitude calculada para cada onda. Assim, quanto maior a densidade espectral associada a uma determinada frequência, maior será a importância dessa frequência para explicar a periodicidade da série. O periodograma é justamente um gráfico da densidade espectral em função das frequências.

Na Figura \ref{fig:cap-analise-explo-periodograma}, apresentamos o periodograma da série horária de ozônio da cidade de São Paulo de 2008 a 2013. Podemos observar que o período\footnote{O período é o inverso da frequência.} mais importante para explicar a periodicidade da série corresponde a um dia, isto é, o periodograma aponta sazonalidade diária, o que é esperado se observarmos a Figura  \ref{fig:cap-analise-explo-O3-DPII-media-horaria}.

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{figuras/cap-analise-explo-periodograma.pdf}
	\caption{Periodogramas para a concentração horária de ozônio medida na cidade de São Paulo (estação de monitoramento Dom Pedro II), no período de outubro de 2008 a junho de 2013. Dados disponibilizados por \cite{Salvo2014}. No painel (a), apresentamos a densidade espectral contra a frequência. No painel (b), resumimos a densidade espectral por período, apresentado em dias.}
	\label{fig:cap-analise-explo-periodograma}
\end{figure}

%Também existem testes para a identificação de tendência e sazonalidade --- teste de Friedman.

Existem na literatura técnicas para remover o componente sazonal de uma série \citep{Morettin2004}, mas esse tópico não será abordado aqui. Nosso foco será ajustar modelos que contemplem o componente sazonal, como veremos no Capítulo \ref{cap:regressao}.

Para mais informações sobre tendência e sazonalidade, recomendamos a leitura do primeiro capítulo de \cite{Shumway2006}.

\subsection{Autocorrelação}
\label{sec:autocorrelacao}

É natural supormos a existência de algum grau de associação entre as observações de uma série temporal coletadas em instantes próximos. Por exemplo, considere a concentração de um poluente medida às nove da manhã em uma certa localidade. Se o valor observado foi alto, as concentrações às oito e às dez da manhã provavelmente também foram altas. Essa informação extraída de $Y_t$ sobre o valor das observações anteriores, $Y_{t-1}, Y_{t-2}, \dots$, ou das seguintes, $Y_{t+1}, Y_{t+2}, \dots$, é chamada de \textit{autocorrelação} ou, neste contexto, \textit{correlação temporal}.

Dependendo da forma como as observações estão associadas, podemos definir diferentes tipos de correlação. Uma das medidas mais simples e mais utilizadas na prática se chama \textit{correlação linear}. Ela supõe que a relação entre as observações pode ser descrita por uma função linear, ou seja, invariante ao valor das observações\footnote{Para mais detalhes sobre a interpretação de linearidade, consulte a Seção \ref{sec:linearidade}.}. Quando outro tipo de relação não for especificada, essa será a definição utilizada neste trabalho para descrevermos a correlação temporal entre as observações.

A autocorrelação de uma série pode ser representada pela \textit{função de autocorrelação}, digamos $\rho(s,t)$, que mede a previsibilidade da série no instante $t$, a partir apenas do valor da variável no instante $s$. Essa medida varia no intervalo $[-1,1]$, com os extremos representando uma correlação perfeita entre as observações $Y_t$ e $Y_s$. Se $Y_t$ pode ser perfeitamente predita por $Y_s$ por meio de uma função linear, então a autocorrelação será 1, se a associação for positiva, ou -1, se a associação for negativa.

Fazendo $h = t-s$, a função de autocorrelação pode ser estimada por

\begin{displaymath}
\rho(0, h) = \rho(h) =  \frac{\gamma(h)}{\gamma(0)},
\end{displaymath}
sendo

\begin{equation}
\gamma(h) = \frac{1}{n}\sum_{t=1}^{n-h}(y_{t+h} - \bar{y})(y_t - \bar{y})
\label{def:sample-autocov}
\end{equation}
a função de autocovariância amostral, $y_t$ o valor observado no instante $t$ e $\bar{y} = \frac{1}{n}\sum_{t=1}^{n}y_t$ a média amostral.

Na Figura \ref{fig:cap-analise-explo-acf-O3-DPII}, apresentamos a função de autocorreção da concentração de ozônio medida na estação Parque Dom Pedro II. Podemos observar que a autocorrelação é sempre positiva e não decai para o zero, indicando que a série apresenta tendência. Em caso contrário, esperaríamos que apenas observações próximas fossem correlacionadas, e então a função de autocorrelação convergiria rapidamente para zero conforme aumentássemos o valor de $h$.

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{figuras/cap-analise-explo-acf-O3-DPII.pdf}
	\caption{Função de autocorreção da concentração de ozônio diária média, medida na cidade de São Paulo (estação de monitoramento Dom Pedro II), no período de outubro de 2008 a junho de 2011, das 12h às 16h. Dados disponibilizados por \cite{Salvo2014}. As linhas pontilhadas representam os limites $\pm 2/\sqrt{n}$, sendo $n$ o tamanho da amostra. Valores fora desse intervalo de confiança (95\%) podem ser considerados significantemente diferentes de zero.}
	\label{fig:cap-analise-explo-acf-O3-DPII}
\end{figure}

%Como vem sendo enfatizado até aqui, a função de autocorrelação captura a associação linear entre as observações de uma série. Para desmascarar possíveis relações não-lineares, podemos construir uma \textit{matriz de dispersão} de valores defasados.

Note que se as observações $Y_t$ e $Y_{t-1}$ são correlacionadas, e da mesma forma as observações $Y_{t-1}$ e $Y_{t-2}$, parte da correlação entre $Y_t$ e $Y_{t-2}$ pode ser explicada por $Y_{t-1}$. Como a função de autocorrelação nos dá a correlação total entre $Y_t$ e $Y_{t-2}$, independentemente do fato de parte dela poder ser explicada por $Y_{t-1}$, se quisermos encontrar apenas a variabilidade explicada por $Y_{t-2}$ precisamos utilizar a \textit{função de autocorrelação parcial}. No caso geral, essa função mede a correlação entre as observações $Y_t$ e $Y_{t-m}$, controlando pelas observações intermediárias $Y_{t-1}, Y_{t-2}, \dots, Y_{t-m+1}$.

Na Figura \ref{fig:cap-analise-explo-pacf-O3-DPII}, apresentamos a função de autocorreção parcial da concentração de ozônio, como no exemplo anterior. Podemos observar agora que a maioria das defasagens são não significativas. Mesmo assim, ainda encontramos algumas defasagens altas significativos, indicando que a série realmente apresenta alguma tendência.

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{figuras/cap-analise-explo-pacf-O3-DPII.pdf}
	\caption{Função de autocorreção parcial da concentração de ozônio diária média, medida na cidade de São Paulo (estação de monitoramento Dom Pedro II), no período de outubro de 2008 a junho de 2011, das 12h às 16h. As linhas pontilhadas representam os limites $\pm 2/\sqrt{n}$, sendo $n$ o tamanho da amostra. Valores fora desse intervalo de confiança (95\%) podem ser considerados significantemente diferentes de zero.}
	\label{fig:cap-analise-explo-pacf-O3-DPII}
\end{figure}

Até agora discutimos como avaliar a correlação entre observações defasadas de uma mesma série. A seguir, vamos discutir como avaliar a associação entre observações de duas ou mais séries.

\subsection{Função de correlação cruzada}

Muitas vezes, queremos avaliar a previsibilidade de uma determinada série $Y_t$ a partir de outra série, digamos $X_s$. Nesse caso, utilizamo a \textit{função de correlação cruzada}, que pode ser estimada por

\begin{displaymath}
\rho_{xy}(h) = \frac{\gamma_{xy}(h) }{\sqrt{\gamma_x(0) \gamma_y(0)}},
\end{displaymath}
sendo $\gamma_.(h)$ como definido em (\ref{def:sample-autocov}) e

\begin{displaymath}
\gamma_{xy}(h) = \frac{1}{n}\sum_{t=1}^{n-h}(x_{t+h} - \bar{x})(y_{t} - \bar{y})
\end{displaymath}
a função de covariância cruzada amostral. Essa expressão nos dá a relação entre $Y_t$ e $X_{t+h}$, para todo $t \geq 0$. Assim, valores positivos de $h$ revelam o quanto $Y_t$ antecipa $X_{t+h}$ e valores negativos de $h$ o quanto $X_{t+h}$ antecipa $Y_t$. Repare que $\rho_{XY}(h) = \rho_{YX}(-h)$.

Em estudos de poluição do ar, é muito comum a inclusão de variáveis defasadas na análise. Essas variáveis representam fenômenos que antecipam a formação de um poluente ou a ocorrência de doenças. Uma chuva no período da manhã, por exemplo, além de alterar o trânsito, pode diminuir a concentração de poluentes no começo da tarde. Altos níveis de poluentes em um determinado dia, podem aumentar o número de internações por problemas respiratórios dias ou até semanas depois.

A identificação de quais variáveis defasadas devem entrar na análise pode ser uma tarefa difícil, principalmente quando existe muita incerteza sobre o processo de geração do fenômeno sob estudo. A função de correlação cruzada é uma boa alternativa neste caso. Com ela, podemos avaliar quais são os valores da defasagem $h$ que geram maior correlação entre as séries e utilizá-los para definir as variáveis defasadas.

A Figura \ref{fig:cap2_ccf} apresenta a função de correlação cruzada do ozônio em função da temperatura na estação Parque Dom Pedro II. Ambas as medidas são horárias. Observamos que a maior correlação (após a defasagem zero) é na defasagem -1, isto é, a concentração de ozônio parece ser altamente associada com a temperatura medida uma hora antes. Assim, a temperatura no instante $t-1$ é uma boa candidata para ser incluída no modelo.

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{ccf_temp.pdf}
	\caption{Função de correlação cruzada do ozônio em função da temperatura na estação Dom Pedro II (São Paulo) no período de outubro de 2009 a junho de 2011. As linhas pontilhadas representam os limites $\pm 2/\sqrt{n}$, sendo $n$ o tamanho da amostra. Valores fora desse intervalo de confiança (95\%) podem ser considerados significantemente diferentes de zero.}
	\label{fig:cap2_ccf}
\end{figure}

Em alguns casos, quando o fenômeno associado não varia muito no tempo, podemos considerar a média de um certo intervalo como variável defasada. Pela Figura \ref{fig:cap2_ccf}, observamos uma certa correlação entre o ozônio e a temperatura nas defasagens de -5 a -8. Assim, a média da temperatura medida entre $t-8$ e $t-5$ também poderia ser incluída no modelo.

As técnicas abordadas até aqui podem ser utilizadas para obter um conhecimento inicial sobre o fenômeno estudado, auxiliando-nos a escolher a melhor estratégia de modelagem. No próximo capítulo, apresentaremos os principais modelos utilizados em análises envolvendo poluição do ar.

\section{Visualizando dados de poluição durante a greve de caminhoneiros}

\textit{A greve dos caminhoneiros} foi como ficou conhecida a paralisação de caminhoneiros autônomos em todo o território brasileiro em maio de 2018. As manifestações começaram no dia 21 de maio e duraram até o início de junho. Nesse período, muitas cidades sofreram com desabastecimento, principalmente de combustível, diminuindo não apenas o tráfego de veículos pesados, mas também de automóveis. Como as emissões veiculares são a principal fonte de diversos poluentes em centros urbanos, seria interessante analisarmos o impacto dessas paralisações nos níveis de poluição.

Utilizando os dados disponibilizados pela Companhia de Ambiental do Estado de São Paulo (CETESB), analisamos a concentração de alguns poluentes entre os dias 23 e 30 de maio\footnote{Período em que as consequências das paralisações foram mais intensas.} na região metropolitana de São Paulo. Os poluentes considerados foram: monóxido de carbono (CO), ozônio (O$_3$), monóxido e dióxido de nitrogênio (NO e NO$_2$) e material particulado 10 (MP10). Também consideramos períodos anteriores e posteriores à greve, para avaliar a mudança causada pelas paralisações, e os mesmos dias em anos anteriores, em que não houve greve. O período total analisado foi de 1º de maio a 14 de junho, dos anos de 2016, 2017 e 2018.

As concentrações de cada poluente foram medidas em estações de monitoramento da CETESB: Osasco, Pinheiros, Parque Dom Pedro II e Ibirapuera. O critério para a escolha foi a disponibilidade de dados para os poluentes escolhidos e o perfil do tráfego de veículos na região das estações. As estações Parque Dom Pedro II e Pinheiros ficam em regiões de tráfego intenso, a primeira no centro da cidade e a segunda próxima à marginal Pinheiros, via expressa que liga as zonas sul, oeste e norte. A estação de Osasco também fica numa região de tráfego intenso e relativamente próxima a duas rodovias. A estação Ibirapuera não é muito afetada pelo tráfego pois fica dentro do Parque Ibirapuera e será utilizada como comparação.

Para construir os gráficos das séries, utilizamos o gráfico apresentado na Figura \ref{fig:cap-explo-medias-diarias} para avaliar a média horária de cada poluente em cada dia da semana. Assim, em vez de utilizarmos as séries horárias, que apresentam sazonalidade diária, construímos as séries da média diária nos horários de pico. Esse gráfico mostra, por exemplo, que os picos de CO acontecem de manhã e no começo da noite e que os níveis desse poluente são bem menores nos fins de semana.

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{cap-explo-medias-diarias.png}
	\caption{Médias horárias por dia da semana durante o período observado dos poluentes considerados na análise.}
	\label{fig:cap-explo-medias-diarias}
\end{figure}

Na Tabela \ref{tab:cap-explo-tab-variacao-media}, apresentamos a variação da média dos poluentes em cada estação no período de greve em relação à média nos períodos anterior e posterior à greve. Nas Figuras \ref{fig:cap-explo-serie-CO}, \ref{fig:cap-explo-serie-O3}, \ref{fig:cap-explo-serie-NO}, \ref{fig:cap-explo-serie-NO2} e \ref{fig:cap-explo-serie-PM10} apresentamos, respectivamente, as séries para o monóxido de carbono, o ozônio, o monóxido e dióxido de nitrogênio e para o material particulado. Observamos que, com exceção do ozônio, a concentração média dos poluentes durante o período de paralisação diminuiu. A maior redução foi a de NO, que é diretamente produzido pela queima de combustíveis, principalmente gasolina e diesel. 

O ozônio é produto de um complexo processo químico que ocorre ao longo do dia, envolvendo diversos compostos e a radiação solar, sendo que uma explicação para o aumento de sua concentração durante a greve pode ser dada pela diminuição dos níveis de NO. O NO faz parte do balanço diário do ozônio, consumindo-o ao longo da tarde e diminuindo suas concentrações. Como o NO diminuiu devido a redução do tráfego de veículos, menos ozônio era consumido e por isso o aumento na concentração.

Esta análise considera apenas as séries durante o período de greve para explicar a variação da concentração dos poluentes. Uma análise mais completa deveria considerar também os efeitos climáticos (temperatura, precipitação, vento, radiação, entre outros). As conclusões aqui supõem que esses fatores se mantiveram homogêneos durante o período analisado, o que pode não ser razoável. Mais resultados podem ser encontrados em \url{https://www.rpollution.com/blog/greve-caminhoneiros/}.

\begin{table}[h!]
	\centering
	\caption{Variação da média dos poluentes em cada estação no período de greve em relação à média nos períodos anterior e posterior à greve}
	\begin{tabular}{M{2cm}|M{2cm}|M{2cm}|M{2cm}|M{2cm} N}
		\hline
		Poluente & Ibirapuera & Osasco & Parque D. Pedro II & Pinheiros & \\
		\hline
		CO & -48.02\% & -32.78\% & -51.16\% & -65.9\% & \\
		O$_3$ & 53.7\% & 	N/A  &	68.43\% & 	126\% & \\
		NO & -89.66\% & -50.9\% & -75.38\% & -83.09\% & \\
		NO$_2$ & -42.49\% &	-13.24\% &	-38.73\% & -39.45\% & \\
		MP10 & N/A 	& -19.1\% &	-19.06\% &	-20.06\% & \\
		\hline
	\end{tabular}
	\label{tab:cap-explo-tab-variacao-media}
\end{table}

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{cap-explo-serie-CO.png}
	\caption{Série observada para o monóxido de carbono. O intervalo entre as retas pontilhadas corresponde ao período de paralisações.}
	\label{fig:cap-explo-serie-CO}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{cap-explo-serie-O3.png}
	\caption{Série observada para o ozônio. O intervalo entre as retas pontilhadas corresponde ao período de paralisações.}
	\label{fig:cap-explo-serie-O3}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{cap-explo-serie-NO.png}
	\caption{Série observada para o monóxido de nitrogênio. O intervalo entre as retas pontilhadas corresponde ao período de paralisações.}
	\label{fig:cap-explo-serie-NO}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{cap-explo-serie-NO2.png}
	\caption{Série observada para o dióxido de nitrogênio. O intervalo entre as retas pontilhadas corresponde ao período de paralisações.}
	\label{fig:cap-explo-serie-NO2}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{cap-explo-serie-PM10.png}
	\caption{Série observada para o material particulado (PM10). O intervalo entre as retas pontilhadas corresponde ao período de paralisações.}
	\label{fig:cap-explo-serie-PM10}
\end{figure}