\documentclass[a4paper,12pt]{article}
\usepackage{natbib}

\usepackage[brazil, english]{babel}
\usepackage[latin1]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{color}
\usepackage{ulem} 

\usepackage{amsmath}
\usepackage{lineno}

\usepackage{graphicx}
\graphicspath{{../../text/figuras/}}
\usepackage{epsfig}


\usepackage{multirow}

\usepackage{array}
\newcolumntype{M}[1]{>{\centering\arraybackslash}m{#1}}
\newcolumntype{N}{@{}m{0pt}@{}}

\usepackage{hyphenat}

\bibliographystyle{amsplnat}


\title{Nonlinear models and machine learning techniques for accessing the effect of the gasoline/ethanol share on ozone concentration}
\author{William Nilson Amorim, Antonio Carlos Pedroso de Lima, \\ Julio M. Singer,  Carmen D.S. André, \\
{\small Departamento de Estatística, Universidade de São Paulo, Brazil} \\
Maria de Fátima Andrade, \\
{\small Departamento de Ciências Atmosféricas, Universidade de São Paulo, Brazil} \\
Paulo H.N. Saldiva \\
{\small Instituto de Estudos Avançados, Universidade de São Paulo, Brazil}
}
\date{}

\begin{document}
	
%\linenumbers
	
\maketitle

Bio-ethanol, a quasi-renewable fuel widely used in some countries as a cleaner option than gasoline, has been in the focus of the energy agenda since the European Commission stated that by 2050 the European Union should cut 20\% of the greenhouse gas emissions relatively to 1990 levels and increase to 20\% the amount of renewable energy used.

The ethanol/gasoline shift as vehicles fuel is directly associated with the atmospheric balance of nitrate oxides (NOx) and organic volatile composts (VOCs), since gasoline burning generates more NOx while partial burning of ethanol and its evaporation generates more VOCs. This balance is an important component to describe the tropospheric ozone formation along the day \citep{SashaMadronich2014}. 

In the past years, some studies have discussed the actual impact of shifting gasoline to ethanol as primary fuel in bi-fuel light-duty vehicles. \cite{Salvo2014} showed that ozone concentration decreased as the share of bi-fuel vehicles burning gasoline rose from 14 to 76$\%$ in São Paulo, Brazil, analyzing data from 2008 to 2011, and shed a valid concern about whether ethanol is a safer substitute for gasoline with respect to its relation with ozone concentration.

Besides ozone, particulate matter has also been subject of many air pollution studies, mostly for the lack of regulation, lack of a safe threshold, and its effects on public health. \cite{Salvo2017} extended this work analyzing data from 2008 to 2013 and other pollutants, like fine particles. The authors reached the same conclusion for ozone concentration, but they observed that ambient number concentrations of 7-100nm diameter particles (ultra-fine particles) rise along with the use of gasoline.

This work has as primary goal to analyze if the association between ozone and the estimated proportion of vehicles burning gasoline is in fact linear or it can be better describe with more sophisticated non-linear models, such as generalized additive models, and algorithmic models, such as random forests and XGBoost.

%and (2) investigate the association between mortality and the estimated proportion of vehicles burning gasoline. To reach this goals, we used more sophisticated non-linear models.


\section{Pollution, weather and traffic data}

The data used in this study was collected, organized and provide by \cite{Salvo2017}. It consist of air pollution, meteorologic and traffic data, as well the \textit{shareE25}, the estimated proportion of bi-fuel vehicles burning gasoline with 25\% ethanol (E25) over pure ethanol (E100).

The \textit{shareE25} variable was estimated using information on the price of ethanol at the pump and the motorist-level revealed-choice survey data \citep{Salvo2013}. Such values were estimated weekly for the entire city, implying that the proportion of bi-fuel vehicles running on E25 was the same for all the monitoring stations where the pollutants were recorded hourly.

The air pollution and meteorologic data, namely ozone concentration, temperature, solar radiation, humidity, wind speed and precipitation, was measured hourly in several monitoring stations along the city  maintained by the environmental authority of the state of São Paulo (CETESB). The traffic data, also measured hourly, was provided by the city traffic authority (CET).

We also consider calendar data: day of week, week of year and indicators for public holidays and year end vacations.

More information about the data can be found in supplementary information of \cite{Salvo2017}.

\section{Statistical analysis}

To analyze the effect of the \textit{shareE25} variation on the ozone levels, \cite{Salvo2017} used a linear regression model, which assumes that the relation between this to variables is the same for all the values of \textit{shareE25}.

To investigate the linearity assumption, we applied three non-linear models on the exactly same variables considered by the authors. The first is the well established \textit{generalized additive model} (GAM), which allows one to associate each one of the predictors to the response variable using non-linear functions. The second one is a \textit{bagging} tree model known as \textit{random forest}. This model consider a high number of different regression trees and average its results to make predictions. The third is a \textit{boosting} model called XGBoost. This model applies regressions trees sequentially to the data, focusing the every fit where the previous model had the higher error.  Due to the lack of interpretation, the latter two models are very little used in studies where the main goal is to make associations between variables. To work around this problem, we used a graphic interpretation technique called \textit{accumulated local effects} (ALE) plot \citep{Apley2016}.

More details about this models can be found in \cite{Hastie2008} and \cite{James2013}.

Following \cite{Salvo2017}, we used as response the daily 12pm to 5pm ozone concentration average, excluding the cold months from June to September. We have ozone data available from 12 monitoring stations in the city. We also considered the same predictors as the authors presented in the Table \ref{tab:variaveis-modelo-salvo-2017}.

\begin{table}[h!]
	\centering
	\caption{Predictors considered for the ozone models}
	\begin{tabular}{M{2cm}|M{8cm}|M{3cm} N}
		\hline 
		Type & Variables & Number of parameters & \\[10pt]
		\hline 
		Ethanol & Estimated proportion of cars running by gasoline (E25) & 1 & \\[10pt]
		\hline
		Station & Monitoring station dummies. & 11 & \\[10pt] 
		\hline
		Calendar & Dummies for day of week, week of year, vacation periods and public holidays.  &  44 & \\[10pt] 
		\hline 
		Trend & General and station specific trend term. &  12 & \\[10pt] 
		\hline 
		Climate & Temperature, solar radiation, humidity, wind speed and dummies for precipitation and thermal inversion.. & 9 & \\[10pt]
		\hline 
		Traffic & Dummies for station specific and city vehicle traffic intensity, as well inauguration of important beltway. & 18  & \\[10pt]
		\hline 
		\textbf{Total} & \textbf{16 predictors + intercept term} & \textbf{96 parameters*}  & \\[10pt]
		\hline
	\end{tabular}
	\\
	\vspace{1mm}
	\scriptsize{*95 parameters from predictors + 1 parameters from intercept term.}
	\label{tab:variaveis-modelo-salvo-2017}
\end{table}

The model considered by \cite{Salvo2017} estimated a coefficient of -16.66 $\pm$ 10.01 to the \textit{shareE25} variable, suggesting that an increase of the proportion of cars burnning E25 in the city is associated with a linear decrease of ozone levels. To compare Salvo's results with ours, we used the root mean square error estimated by cross validation and the proportion of variance explained. For the model used by \cite{Salvo2017}, these two quantities were, respectively, 19.74 and 70.65\%.

\section{Results}

We fitted three generalized additive models, the first using the Normal distribution, the second using the Gamma distribution and the last using the Inverse Normal distribution. The non-linear functions were assign to all numeric predictors: \textit{shareE25}, temperature, radiation, humidity, wind speed and trend. The other predictors were linear associated with the response. Smoothing splines were used to estimate the functions and the smoothing degree was chosen by cross validation. In the three models, the \textit{shareE25} variable was considered statistically significant to explain the ozone concentration. The performance of each model is described in the Table \ref{tab:cap-comb-resultados-gam}.

\begin{table}[h!]
	\centering
	\caption{Distribution used, root mean square error (RMSE), proportion of the variance explained and five more important variables for the generalized additive models.}
	\begin{tabular}{M{2cm}|M{1cm}|M{2cm}|M{6cm} N}
		\hline
		Distribution & RMSE & \% var. explained & 5 most important variables &\\
		\hline
		Normal & 19.82 & 70.50 & Temperature, wind speed, humidity, radiation e trend &\\
		Gamma & 20.07 & 69.50 & Temperature, wind speed, humidity, radiation e trend  &\\
		Inverse Normal & 29.28 & 45.30 & Temperature, radiation, humidity, wind speed e trend &\\
		\hline                                                             
	\end{tabular}
	\label{tab:cap-comb-resultados-gam}
\end{table}

The results from the Normal and Gama models were close to those for the linear regression fitted by \cite{Salvo2017}, while the Inverse Normal model got bigger RMSE and lower R$^2$, indicating that this distribution is not appropriated to fit the data. Contrary to the linear regression model, the trend term was held as one of the five most important variables to explain the variability of the ozone concentration in these three models. It presumably happened due to the flexibility of the GAM to represent the non-linearity of this temporal component. The \textit{shareE25} variable was the 13th more important\footnote{The variable importance measure for these models is the reduction in the generalized cross-validation estimate of error when each predictor's feature is added to the model.} in the Normal model, and the 9th in the Gama model and Inverse Normal model.

The usual method to interpret the generalized additive models is to plot each predictor by its estimated non-linear function. Figure \ref{fig:comb-gam-plot} shows this plot for the \textit{shareE25} variable, suggesting a non-linear relation between this variable and the concentration of ozone: positive in the extremes (10\% - 20\% and 60\% - 80\%) and negative in the center (20\% - 60\%).

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{cap-comb-gam-plot.pdf}
	\caption{Non-linear function estimated by the Normal generalized additive model to the \textit{shareE25} variable. The gray area represents a 95\% confidence interval.}
	\label{fig:comb-gam-plot}
\end{figure}

To evaluate the variability of the estimates, we also followed the strategy in \cite{Salvo2017} and fitted the Normal GAM (which had the best performance) in 200 bootstrap samples. Figure \ref{fig:comb-gam-plot-bs} shows the 200 estimated curves (in gray) for the \textit{shareE25} variable in the bootstrap models and the cubic splines smoothed curve (in blue). The non-linear pattern found is the same as described earlier. The high variability in the extremes is result of few data with low or high estimated proportion of cars burning E25.


\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{cap-comb-gam-plot-bs.pdf}
	\caption{In gray, the 200 estimated curves for the \textit{shareE25} variable in the bootstrap models. In blue, the cubic splines smoothed curve.}
	\label{fig:comb-gam-plot-bs}
\end{figure}

The Table \ref{tab:cap-comb-resultados-random-forest} shows the results of the random forest and the XGBoost. As expected we obtained lower test errors (14.11 and 12.24) and higher R$^2$ (85.72 and 88.56) than the linear regression and the additive models. The five most important predictors for both models were: temperature, humidity, radiation, wind speed and trend, just like in the GAM. The \textit{shareE25} was the 6th most important variable. 

\begin{table}[h!]
	\centering
	\caption{Root mean square error (RMSE), proportion of the variance explained and five most important variables for the random forest and the XGBoost models. The hyperparameters of this models were set using 5-fold cross validation.}
	\begin{tabular}{M{2cm}|M{2cm}|M{2cm}|M{6cm} N}
		\hline
		Model  & RMSE & \% var. explained & Most important variables & \\
		\hline
		Random forest & 14.11 & 85.72 & \multirow{1}{6cm}{Temperature, humidity, radiation, wind speed and trend} & \\ 
		XGBoost & 12.24 & 88.56 & & \\
		\hline
	\end{tabular}
	\label{tab:cap-comb-resultados-random-forest}
\end{table}

The ALE plot for the random forest in the left panel of the Figure \ref{fig:cap-comb-rf-xgboost-p-ale} shows a \textit{shareE25} effect very similar of the one suggest by the additive model. However, the ALE plot for the XGBoost (in the right panel) does not show a clear relation between the variables. Moreover, it suggests now that the variables could be positively associated.

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{cap-comb-rf-xgboost-p-ale.pdf}
	\caption{ALE plots of the \textit{shareE25} predictor for the random forest and XGBoost. The y-axis gives us the main effect of the \textit{shareE25} at a certain value compared to the average prediction of the data.}
	\label{fig:cap-comb-rf-xgboost-p-ale}
\end{figure}

To evaluate the interpretations suggested by the ALE plots, the Figure \ref{fig:cap-comb-xgboost-graficos-clima-ingles-iml} shows these plots for the climates variables: temperature, humidity, radiation and wind speed. The interpretation found for each predictor is plausible with the available knowledge about the tropospheric ozone formation:  temperature and radiation are positively associated while wind speed and humidity are negatively associated.

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{cap-comb-xgboost-graficos-clima-ingles-iml.pdf}
	\caption{ALE plots of the climate predictors for the XGBoost. The y-axis gives us the main effect of these variables at a certain value compared to the average prediction of the data.}
	\label{fig:cap-comb-xgboost-graficos-clima-ingles-iml}
\end{figure}

\section{Discussion}

The analysis conducted in this work suggests that the relation between the ozone concentration in the city of Sao Paulo and the \textit{shareE25} (if it exists) is highly non-linear, and then it is not appropriate to use a linear model in the attempt to explain it.

All the non-linear models apply to the data indicated a non-linear association, with abrupt increases and decreases of the effect of the \textit{shareE25} in the ozone concentration. Also, different models point in different directions: while the additive models and the random forest suggested a general negative association, the XGBoost suggested a positive association. 

The findings here advocate for two hypotheses: (1) the relation between the use of ethanol/gasoline and ozone formation is too complex and cannot be fitted by the models considered and/or it does not have a practical explanation; or (2) the \textit{shareE25} variable does not quite capture the real proportion of cars burning gasoline in the city and the associations found by the models are spurious.

Supporting the first hypothesis we have the known complex process behind the tropospheric ozone formation and the non-linear effect suggest by the models. The second hypothesis is supported by the different results found throughout the analysis and the possible measurement error in the \textit{shareE25} variable and the strong supposition of considering only one value for the whole city.

Considering also the practical relevance of the study, a decrease of 8.3 $\mu g/m^3$ in the daily mean ozone concentration pointed by \cite{Salvo2017} when \textit{shareE25} raises from 30\% to 80\% would decrease the mean ozone concentration found in the sample only from 72.2 to 63.9 $\mu g/m^3$. Even if the linear model is in fact expressing the true relation between these variables, while a very important finding, it could not be sufficient to motivate public policies to reduce ethanol emissions. Furthermore, the impact of a average 8.3 $\mu g/m^3$ decrease in ozone levels in morbidity and mortality must be evaluated to better access this issue. 

%\newpage
%\bibliography{C:/Users/William/Dropbox/Latex/Bibs/atlas.bib}
%\bibliography{/home/acarlos/Dropbox/FAPESP/Tematicos/MODAU/Ozonio/atlas.bib}
%\bibliography{/home/jmsinger/Dropbox/MODAU/Etanol/atlas.bib}
\bibliography{../../../Latex/Bibs/atlas.bib}
			
\section*{Acknowledgements} 

This research received financial support from Coordenação de Aperfeiçoamento de Pessoal de Nível Superior (Capes), Conselho Nacional de Desenvolvimento Científico e Tecnológico (CNPq, grant 3304126/2015-2)
and Fundação de Amparo à Pesquisa do Estado de São Paulo (FAPESP, grant 2013/21728-2), Brazil.
 			
\section*{Author contributions}

W.N.A., A.C.P.L., J.M.S. and C.D.S.A. analyzed the data; M.F.A. contributed with climate and pollutant chemistry knowledge; P.H.N.S. suggested the theme; all authors wrote the paper.

\section*{Additional information}

Correspondence and request for materials should be addressed to W.N.A.
All the figures and the R codes used in the statistical analysis may be obtained respectively at  http://bit.do/amorim\_et\_al\_figures and \\ http://bit.do/amorim\_et\_al\_codes. 

\section*{Competing financial interests}

The authors declare no competing financial interests.


\end{document} 

